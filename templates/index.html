<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Text Story Video Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/imessage.css') }}?v={{ range(1, 999999) | random }}" type="text/css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        .page-container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        
        .clipboard-section {
            flex: 0 0 300px;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .conversation-input {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .conversation-input textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: inherit;
            resize: vertical;
        }
        
        .convert-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .convert-btn:hover {
            background: #218838;
        }
        
        .clipboard-items {
            border-top: 2px solid #ddd;
            padding-top: 20px;
        }
        
        .clipboard-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .clipboard-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .copy-btn:hover {
            background: #0056b3;
        }
        
        .copy-btn.copied {
            background: #28a745;
        }
        
        .speaker-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .image-search-section {
            flex: 0 0 400px;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
            margin-left: 20px;
        }

        .search-box {
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-box button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .image-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 10px 5px;
        }

        .image-result {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-result img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-buttons {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: white;
        }

        .image-buttons button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }

        .load-more {
            margin-top: 20px;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            display: none;
            font-size: 14px;
        }

        .loading-indicator {
            text-align: center;
            margin: 15px 0;
            display: none;
            color: #666;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px;
            justify-content: space-between;
            border-bottom: 1px solid #e5e5e5;
        }

        .header-left {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 1000;
        }

        .header-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 50px;
        }

        .header-text {
            padding: 0 10px;
            font-weight: 500;
        }

        .header-right {
            flex: 0 0 50px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
        }

        .video-call-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgb(10, 132, 255);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            margin-right: -5px;
        }

        .video-call-icon svg {
            width: 26px;
            height: 26px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-miterlimit: 10;
        }

        .dark-theme .video-call-icon {
            color: rgb(10, 132, 255);
        }

        .context-menu {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .context-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
        }

        .context-menu button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Clipboard Section -->
        <div class="clipboard-section">
            <!-- Conversation Input -->
            <div class="conversation-input">
                <textarea id="conversationInput" placeholder="Paste your ChatGPT conversation here..."></textarea>
                <button class="convert-btn" onclick="convertConversation()">Convert Conversation</button>
            </div>
            <!-- Clipboard Items -->
            <div class="clipboard-items" id="clipboardItems">
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="container" id="chatContainer">
                <div class="header">
                    <div class="header-left">
                        <svg fill="rgb(10, 132, 255)" width="24px" height="24px" viewBox="0 0 52 52" data-name="Layer 1" id="Layer_1" xmlns="http://www.w3.org/2000/svg">
                            <g data-name="Group 132" id="Group_132">
                                <path d="M38,52a2,2,0,0,1-1.41-.59l-24-24a2,2,0,0,1,0-2.82l24-24a2,2,0,0,1,2.82,0,2,2,0,0,1,0,2.82L16.83,26,39.41,48.59A2,2,0,0,1,38,52Z"/>
                            </g>
                        </svg>
                    </div>
                    <div id="backButtonContextMenu" class="context-menu">
                        <button id="savePosition">Save Position</button>
                    </div>
                    <div class="header-center">
                        <div class="profile-image" id="profileImageContainer">
                            <img src="{{ url_for('static', filename='images/profile.jpg') }}" alt="Profile" id="profileImage">
                            <input type="file" id="profileUpload" accept="image/*" style="display: none;">
                        </div>
                        <div class="header-text" id="headerName" contenteditable="true" spellcheck="false">
                            John Doe
                        </div>
                    </div>
                    <div class="header-right">
                        <button class="video-call-icon">
                            <svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                                <path d="M36,36c0,2.209-1.791,4-4,4H5c-2.209,0-4-1.791-4-4V14c0-2.209,1.791-4,4-4h27c2.209,0,4,1.791,4,4V36z"/>
                                <polygon points="49,14 36,21 36,29 49,36"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="message-container" id="messageContainer">
                    <div class="dynamic-container">
                        <!-- Messages will be added here -->
                    </div>
                </div>
                <div class="input-area">
                    <div class="imessage-input">
                        <input type="text" id="messageInput" placeholder="iMessage">
                        <button id="senderToggle">⇄</button>
                        <button id="addPicture">📷</button>
                        <input type="file" id="pictureUpload" accept="image/*" style="display: none;">
                        <button id="addMessage">Send</button>
                    </div>
                    <button class="generate-button" id="generateBtn">Generate Video</button>
                </div>
            </div>
            
            <!-- Settings wrapper -->
            <div class="settings-wrapper">
                <div class="theme-settings">
                    <h3>Choose your theme:</h3>
                    <div class="theme-selector">
                        <input type="radio" id="lightTheme" name="theme" value="light" checked>
                        <label for="lightTheme">Light Theme</label>
                        <input type="radio" id="darkTheme" name="theme" value="dark">
                        <label for="darkTheme">Dark Theme</label>
                    </div>
                </div>
                <div class="voice-settings">
                    <h3>Choose Voice Actors</h3>
                    <div class="api-key-section">
                        <input type="text" id="elevenLabsKey" placeholder="Enter ElevenLabs API Key" class="api-key-input">
                        <button id="saveApiKey">Save API Key</button>
                    </div>
                    <div class="voice-selector-container">
                        <div class="voice-selector">
                            <label for="senderVoice">Sender Voice:</label>
                            <select id="senderVoice">
                                <option value="male">Male (Adam)</option>
                                <option value="female">Female (Jessica)</option>
                                <option value="brian">Male (Brian)</option>
                                <option value="brian">Male (Antoni)</option>
                                <option value="laura">Female (Laura)</option>
                            </select>
                        </div>
                        <div class="voice-selector">
                            <label for="receiverVoice">Receiver Voice:</label>
                            <select id="receiverVoice">
                                <option value="female">Female (Jessica)</option>
                                <option value="male">Male (Adam)</option>
                                <option value="brian">Male (Brian)</option>
                                <option value="brian">Male (Antoni)</option>
                                <option value="laura">Female (Laura)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="video-selection">
                    <h3>Select Background Video</h3>
                    <div class="video-previews">
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448713/ejqmkubzg1qdxzkc7fm4.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background" checked>
                            <label>Style 1</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448707/f1bhluhc6si77uapdawe.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_1">
                            <label>Style 2</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448708/dxo2rlb7kckps0fnfvv4.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_2">
                            <label>Style 3</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dicyxkb4t/video/upload/v1738448706/pytgss2oi9idgch1xhrw.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_3">
                            <label>Style 4</label>
                        </div>
                        <div class="video-option">
                            <video 
                                src="https://res.cloudinary.com/dokndhglh/video/upload/v1739599641/Minecraft_Jump_and_Run_Gameplay_TIKTOK_Format_60fps_1440p_HD_No_Ads_No_Credits_3_-_Minecraft_Gameplay_1080p_h264_mute_youtube_online-video-cutter.com_1_eprmyf.mp4" 
                                loop 
                                muted 
                                class="preview-video"
                                onmouseover="this.play()" 
                                onmouseout="this.pause(); this.currentTime = 0;"
                            ></video>
                            <input type="radio" name="background" value="background_4">
                            <label>Style 5</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Search Section -->
        <div class="image-search-section">
            <h3>Image Search</h3>
            <div class="search-box">
                <input type="text" id="imageSearchInput" placeholder="Search for images...">
                <button onclick="searchImages(true)">🔍</button>
            </div>
            <div class="image-results" id="imageResults">
                <!-- Image results will be added here -->
            </div>
            <div class="loading-indicator" id="loadingIndicator">Loading...</div>
            <button class="load-more" id="loadMoreBtn" onclick="loadMoreImages()">Load More Images</button>
        </div>
    </div>

    <script>
        function convertConversation() {
            const input = document.getElementById('conversationInput').value;
            const clipboardItems = document.getElementById('clipboardItems');
            clipboardItems.innerHTML = ''; // Clear existing items
            
            // Split the input into lines and remove empty lines
            const lines = input.split('\n').filter(line => line.trim());
            
            let currentSpeaker = '';
            let currentMessage = '';
            
            lines.forEach(line => {
                line = line.trim();
                
                // Check for speaker pattern (ends with colon)
                if (line.includes(':')) {
                    // If we have a previous message, add it
                    if (currentSpeaker && currentMessage) {
                        addClipboardItem(currentSpeaker, currentMessage);
                    }
                    
                    // Split new line into speaker and message
                    const [speaker, ...messageParts] = line.split(':');
                    currentSpeaker = speaker.replace(/\*\*/g, '').trim();
                    currentMessage = messageParts.join(':').trim();
                    
                    // If we have both speaker and message, add it
                    if (currentSpeaker && currentMessage) {
                        addClipboardItem(currentSpeaker, currentMessage);
                        currentSpeaker = '';
                        currentMessage = '';
                    }
                } else {
                    // If line doesn't contain colon, it's probably a continuation of previous message
                    if (currentSpeaker) {
                        currentMessage += ' ' + line;
                    }
                }
            });
            
            // Add any remaining message
            if (currentSpeaker && currentMessage) {
                addClipboardItem(currentSpeaker, currentMessage);
            }
        }

        function addClipboardItem(speaker, message) {
            const clipboardItems = document.getElementById('clipboardItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'clipboard-item';
            itemDiv.innerHTML = `
                <div class="clipboard-text">
                    <div class="speaker-name">${speaker}:</div>
                    ${message}
                </div>
                <button class="copy-btn" onclick="copyText(this)">Copy</button>
            `;
            clipboardItems.appendChild(itemDiv);
        }

        function copyText(button) {
            const textElement = button.previousElementSibling;
            const speakerName = textElement.querySelector('.speaker-name').textContent;
            const messageText = textElement.textContent.replace(speakerName, '').trim();
            
            navigator.clipboard.writeText(messageText).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text:', err);
            });
        }

        let messages = [];
        let isSender = true;
        let isGenerating = false;

        const messageInput = document.getElementById('messageInput');
        const messageContainer = document.getElementById('messageContainer');
        const chatContainer = document.getElementById('chatContainer');
        const senderToggle = document.getElementById('senderToggle');
        const addMessageBtn = document.getElementById('addMessage');
        const generateBtn = document.getElementById('generateBtn');

        // Add picture upload functionality
        const addPictureBtn = document.getElementById('addPicture');
        const pictureUpload = document.getElementById('pictureUpload');

        addPictureBtn.addEventListener('click', () => {
            pictureUpload.value = '';
            pictureUpload.click();
        });

        pictureUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addPictureMessage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function addPictureMessage(imageSrc) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSender ? 'sender' : 'receiver'} picture`;
            messageDiv.setAttribute('data-id', Date.now());
            
            const img = document.createElement('img');
            
            // Create a temporary image to get the natural dimensions
            const tempImg = new Image();
            tempImg.onload = function() {
                // Calculate dimensions while maintaining aspect ratio
                const maxWidth = 200;  // Updated max width
                const maxHeight = 300; // Updated max height
                let width = this.width;
                let height = this.height;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }
                
                // Set the dimensions on the actual image
                img.style.width = `${width}px`;
                img.style.height = `${height}px`;
            };
            
            img.src = imageSrc;
            tempImg.src = imageSrc;
            
            messageDiv.appendChild(img);
            
            const dynamicContainer = document.querySelector('.dynamic-container');
            dynamicContainer.appendChild(messageDiv);
            
            updateMessagesArray();
            scrollToBottom();
        }

        function scrollToBottom() {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Function to update messages array and ensure synchronization
        function updateMessagesArray() {
            const dynamicContainer = document.querySelector('.dynamic-container');
            messages = Array.from(dynamicContainer.children).map(messageDiv => {
                const message = {
                    id: messageDiv.getAttribute('data-id') || Date.now(),
                    is_sender: messageDiv.classList.contains('sender'),
                    soundEffect: messageDiv.getAttribute('data-sound-effect') || null,
                    type: messageDiv.classList.contains('picture') ? 'picture' : 'text'
                };
                
                if (message.type === 'picture') {
                    message.text = messageDiv.querySelector('img').src;
                } else {
                    message.text = messageDiv.textContent.trim();
                }
                
                return message;
            }).filter(msg => msg.text);
            
            console.log('Updated messages array:', messages);
        }

        // Modify addMessage function
        function addMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSender ? 'sender' : 'receiver'}`;
            messageDiv.textContent = text;
            messageDiv.setAttribute('data-id', Date.now());
            
            const dynamicContainer = document.querySelector('.dynamic-container');
            dynamicContainer.appendChild(messageDiv);

            updateMessagesArray(); // Update messages array after adding
            
            messageInput.value = '';
            messageInput.focus();
            scrollToBottom();
        }

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMessage();
        });

        senderToggle.addEventListener('click', () => {
            isSender = !isSender;
            senderToggle.classList.toggle('receiver');
        });

        addMessageBtn.addEventListener('click', addMessage);

        // Add this after your existing variable declarations (but before the chatContainer declaration)
        const themeInputs = document.querySelectorAll('input[name="theme"]');

        // Add theme switching functionality
        themeInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                const isDark = e.target.value === 'dark';
                chatContainer.classList.toggle('dark-theme', isDark);
                localStorage.setItem('chatTheme', e.target.value);
            });
        });

        // Load saved theme preference
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('chatTheme') || 'light';
            const themeInput = document.querySelector(`input[value="${savedTheme}"]`);
            if (themeInput) {
                themeInput.checked = true;
                chatContainer.classList.toggle('dark-theme', savedTheme === 'dark');
            }
        });

        // Add this near the beginning of your script section
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved API key
            const savedApiKey = localStorage.getItem('elevenLabsApiKey');
            if (savedApiKey) {
                document.getElementById('elevenLabsKey').value = savedApiKey;
            }

            // Add save button functionality
            document.getElementById('saveApiKey').addEventListener('click', () => {
                const apiKey = document.getElementById('elevenLabsKey').value.trim();
                if (apiKey) {
                    localStorage.setItem('elevenLabsApiKey', apiKey);
                    alert('API Key saved successfully!');
                } else {
                    alert('Please enter an API key');
                }
            });
        });

        // Update the generateBtn click handler to use the saved API key
        generateBtn.addEventListener('click', async () => {
            if (isGenerating) return;
            isGenerating = true;
            generateBtn.textContent = 'Generating...';
            
            try {
                updateMessagesArray();
                
                const currentProfileImage = document.getElementById('profileImage').src;
                const currentHeaderName = document.getElementById('headerName').textContent.trim();
                const currentTheme = document.querySelector('input[name="theme"]:checked').value;
                const savedApiKey = localStorage.getItem('elevenLabsApiKey');
                
                if (!savedApiKey) {
                    throw new Error('Please save your ElevenLabs API key first');
                }
                
                const requestData = {
                    messages: messages,
                    profileImage: currentProfileImage,
                    headerName: currentHeaderName,
                    theme: currentTheme,
                    voiceSettings: {
                        apiKey: savedApiKey,
                        sender: document.getElementById('senderVoice').value,
                        receiver: document.getElementById('receiverVoice').value
                    },
                    backgroundVideo: document.querySelector('input[name="background"]:checked').value
                };
                
                console.log('Sending request with theme:', requestData.theme); // Debug log
                
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Video generation failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'output_video.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate video: ' + error.message);
            } finally {
                generateBtn.textContent = 'Generate Video';
                isGenerating = false;
            }
        });
        
        // Initialize scroll position when page loads
        window.addEventListener('load', scrollToBottom);

        // Message editing functionality
        let currentOptionsMenu = null;

        function createOptionsMenu(isPicture) {
            const menu = document.createElement('div');
            menu.className = 'message-options';
            menu.innerHTML = `
                <button class="edit">${isPicture ? 'Swap Picture' : 'Edit'}</button>
                <button class="switch">Switch Side</button>
                <button class="add-textbox-above">Add Textbox Above</button>
                <button class="add-textbox-below">Add Textbox Below</button>
                <button class="sound-effect">Sound Effects</button>
                <button class="delete">Delete</button>
            `;
            return menu;
        }

        function hideOptionsMenu() {
            if (currentOptionsMenu) {
                currentOptionsMenu.remove();
                currentOptionsMenu = null;
            }
        }

        function createSoundEffectsSubmenu(currentEffect) {
            const submenu = document.createElement('div');
            submenu.className = 'sound-effects-submenu';
            
            const effects = ['None', 'vineboom', 'notification', 'rizz', 'imessage_text'];
            
            effects.forEach(effect => {
                const option = document.createElement('div');
                option.className = `sound-effect-option ${currentEffect === effect ? 'selected' : ''}`;
                option.textContent = effect;
                
                const checkmark = document.createElement('span');
                checkmark.className = 'checkmark';
                checkmark.textContent = '✓';
                option.appendChild(checkmark);
                
                option.addEventListener('click', () => {
                    // Remove selection from all options
                    submenu.querySelectorAll('.sound-effect-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Select the clicked option
                    option.classList.add('selected');
                });
                
                submenu.appendChild(option);
            });
            
            return submenu;
        }

        function handleMessageClick(e) {
            const messageDiv = e.target.closest('.message');
            if (!messageDiv) return;

            hideOptionsMenu();

            const optionsMenu = createOptionsMenu(messageDiv.classList.contains('picture'));

            // Append the menu to the body instead of the message
            document.body.appendChild(optionsMenu);
            currentOptionsMenu = optionsMenu;

            // Calculate the message's position relative to the viewport
            const messageRect = messageDiv.getBoundingClientRect();

            // Position the menu
            optionsMenu.style.display = 'block';
            optionsMenu.style.width = '200px';

            if (messageDiv.classList.contains('picture')) {
                // For pictures, position menu to the left
                optionsMenu.style.left = `${messageRect.left - 210}px`;
                optionsMenu.style.top = `${messageRect.top}px`;
            } else {
                // For text messages, position below
                optionsMenu.style.left = `${messageRect.left}px`;
                optionsMenu.style.top = `${messageRect.bottom}px`;
            }

            // Handle picture swap
            if (messageDiv.classList.contains('picture')) {
                optionsMenu.querySelector('.edit').onclick = (e) => {
                    e.stopPropagation();
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.value = '';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = messageDiv.querySelector('img');
                                const newImg = new Image();
                                
                                newImg.onload = function() {
                                    // Calculate dimensions while maintaining aspect ratio
                                    const maxWidth = 200;
                                    const maxHeight = 300;
                                    let width = this.width;
                                    let height = this.height;
                                    
                                    if (width > maxWidth || height > maxHeight) {
                                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                                        width = width * ratio;
                                        height = height * ratio;
                                    }
                                    
                                    // Update the existing img element
                                    img.style.width = `${width}px`;
                                    img.style.height = `${height}px`;
                                    img.src = e.target.result;
                                    
                                    // Force the message container to adjust to new content
                                    messageDiv.style.width = 'auto';
                                    messageDiv.style.height = 'auto';
                                    
                                    updateMessagesArray();
                                };
                                
                                newImg.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                    input.click();
                    hideOptionsMenu();
                };
            } else {
                optionsMenu.querySelector('.edit').onclick = (e) => {
                    e.stopPropagation();
                    messageDiv.contentEditable = true;
                    messageDiv.focus();
                    hideOptionsMenu();
                    
                    messageDiv.addEventListener('input', () => {
                        updateMessagesArray();
                    });
                    
                    messageDiv.onblur = () => {
                        messageDiv.contentEditable = false;
                        updateMessagesArray();
                    };
                };
            }

            // Handle switch side
            optionsMenu.querySelector('.switch').onclick = (e) => {
                e.stopPropagation();
                const isSenderMessage = messageDiv.classList.contains('sender');
                messageDiv.classList.toggle('sender');
                messageDiv.classList.toggle('receiver');
                
                const index = Array.from(messageDiv.parentNode.children).indexOf(messageDiv);
                if (index !== -1 && messages[index]) {
                    messages[index].is_sender = !isSenderMessage;
                }
                hideOptionsMenu();
            };

            // Handle add textbox above
            optionsMenu.querySelector('.add-textbox-above').onclick = (e) => {
                e.stopPropagation();
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessageDiv.textContent = 'New message';
                newMessageDiv.setAttribute('data-id', Date.now());
                messageDiv.parentNode.insertBefore(newMessageDiv, messageDiv);
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Handle add textbox below
            optionsMenu.querySelector('.add-textbox-below').onclick = (e) => {
                e.stopPropagation();
                const newMessageDiv = document.createElement('div');
                newMessageDiv.className = `message ${messageDiv.classList.contains('sender') ? 'sender' : 'receiver'}`;
                newMessageDiv.textContent = 'New message';
                newMessageDiv.setAttribute('data-id', Date.now());
                messageDiv.parentNode.insertBefore(newMessageDiv, messageDiv.nextSibling);
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Handle sound effects
            const soundEffectButton = optionsMenu.querySelector('.sound-effect');
            let soundEffectSubmenu = null;
            
            soundEffectButton.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (soundEffectSubmenu) {
                    soundEffectSubmenu.remove();
                    soundEffectSubmenu = null;
                    return;
                }
                
                const currentEffect = messageDiv.getAttribute('data-sound-effect');
                soundEffectSubmenu = createSoundEffectsSubmenu(currentEffect);
                
                // Position the submenu
                const buttonRect = soundEffectButton.getBoundingClientRect();
                soundEffectSubmenu.style.position = 'absolute';
                soundEffectSubmenu.style.left = `${buttonRect.right}px`;
                soundEffectSubmenu.style.top = `${buttonRect.top}px`;
                
                document.body.appendChild(soundEffectSubmenu);
                
                // Handle submenu clicks
                soundEffectSubmenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const selectedOption = e.target.closest('.sound-effect-option');
                    if (selectedOption) {
                        const selectedEffect = selectedOption.textContent.replace('✓', '').trim();
                        messageDiv.setAttribute('data-sound-effect', selectedEffect);
                        updateMessagesArray();
                    }
                });
            });

            // Handle delete
            optionsMenu.querySelector('.delete').onclick = (e) => {
                e.stopPropagation();
                messageDiv.remove();
                updateMessagesArray();
                hideOptionsMenu();
            };

            // Add click outside to close functionality
            const clickOutsideHandler = (e) => {
                if (!optionsMenu.contains(e.target) && 
                    !messageDiv.contains(e.target) &&
                    (!soundEffectSubmenu || !soundEffectSubmenu.contains(e.target))) {
                    hideOptionsMenu();
                    if (soundEffectSubmenu) {
                        soundEffectSubmenu.remove();
                        soundEffectSubmenu = null;
                    }
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', clickOutsideHandler);
            }, 0);
        }

        messageContainer.addEventListener('click', handleMessageClick);

        // Add a global voice map variable
        const voiceMap = {
            'male': 'pNInz6obpgDQGcFmaJgB',    // Adam's voice ID
            'female': 'cgSgspJ2msm6clMCkdW9',  // Jessica's voice ID
            'brian': 'Yko7PKHZNXotIFUBG7I9',   // Brian's voice ID
            'antoni': 'ErXwobaYiN019PkySvjV',
            'laura': 'EXAVITQu4vr4xnSDxMaL'    // Laura's voice ID
        };

        // Add profile picture change functionality
        const profileImageContainer = document.getElementById('profileImageContainer');
        const profileImage = document.getElementById('profileImage');
        const profileUpload = document.getElementById('profileUpload');

        profileImageContainer.addEventListener('click', () => {
            profileUpload.click();
        });

        profileUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Always use default profile picture on page load
        profileImage.src = "{{ url_for('static', filename='images/profile.jpg') }}";

        let currentPage = 1;
        let currentQuery = '';
        let isSearching = false;

        async function searchImages(newSearch = false) {
            const query = document.getElementById('imageSearchInput').value.trim();
            if (!query) return;
            
            if (newSearch) {
                currentPage = 1;
                document.getElementById('imageResults').innerHTML = '';
            }
            
            if (isSearching) return;
            isSearching = true;
            currentQuery = query;
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            loadingIndicator.style.display = 'block';
            loadMoreBtn.style.display = 'none';

            try {
                const response = await fetch(`/api/search-images?q=${encodeURIComponent(query)}&page=${currentPage}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('imageResults').innerHTML = `Error: ${data.error}`;
                    return;
                }

                const resultsContainer = document.getElementById('imageResults');
                
                data.images.forEach(image => {
                    const div = document.createElement('div');
                    div.className = 'image-result';
                    div.innerHTML = `
                        <img src="${image.thumbnail}" alt="${image.title}">
                        <div class="image-buttons">
                            <button onclick="setAsProfile('${image.url}')">Set Profile</button>
                            <button onclick="addImageToChat('${image.url}')">Add to Chat</button>
                        </div>
                    `;
                    resultsContainer.appendChild(div);
                });

                // Show/hide load more button based on whether there are more results
                loadMoreBtn.style.display = data.hasMore ? 'block' : 'none';
                
            } catch (error) {
                document.getElementById('imageResults').innerHTML = 'Error searching for images';
                console.error('Error:', error);
            } finally {
                isSearching = false;
                loadingIndicator.style.display = 'none';
            }
        }

        function setAsProfile(imageUrl) {
            const profileImage = document.getElementById('profileImage');
            profileImage.src = imageUrl;
        }

        function loadMoreImages() {
            currentPage++;
            searchImages(false);
        }

        // Add enter key support for search
        document.getElementById('imageSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchImages(true);
            }
        });

        // Add infinite scroll
        const imageResults = document.getElementById('imageResults');
        imageResults.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = imageResults;
            if (scrollTop + clientHeight >= scrollHeight - 100 && !isSearching) {
                loadMoreImages();
            }
        });

        function addImageToChat(imageUrl) {
            addPictureMessage(imageUrl);
        }

        // Add dragging functionality for back button
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.querySelector('.header-left');
            const contextMenu = document.getElementById('backButtonContextMenu');
            const savePositionBtn = document.getElementById('savePosition');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;

            // Load saved position
            const savedPosition = localStorage.getItem('backButtonPosition');
            if (savedPosition) {
                const { left, top } = JSON.parse(savedPosition);
                backButton.style.left = left;
                backButton.style.top = top;
            }

            // Prevent default context menu and show custom menu
            backButton.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            });

            // Save position button click handler
            savePositionBtn.addEventListener('click', function() {
                const position = {
                    left: backButton.style.left,
                    top: backButton.style.top
                };
                localStorage.setItem('backButtonPosition', JSON.stringify(position));
                contextMenu.style.display = 'none';
                
                // Show confirmation message
                const toast = document.createElement('div');
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.background = '#28a745';
                toast.style.color = 'white';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '4px';
                toast.style.zIndex = '1002';
                toast.textContent = 'Position saved!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            });

            // Hide context menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!contextMenu.contains(e.target) && !backButton.contains(e.target)) {
                    contextMenu.style.display = 'none';
                }
            });

            // Dragging functionality
            backButton.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                if (e.button === 2) return; // Don't start drag on right click
                initialX = e.clientX - backButton.offsetLeft;
                initialY = e.clientY - backButton.offsetTop;
                isDragging = true;
            }

            function drag(e) {
                if (!isDragging) return;

                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                // Keep button within window bounds
                currentX = Math.max(0, Math.min(currentX, window.innerWidth - backButton.offsetWidth));
                currentY = Math.max(0, Math.min(currentY, window.innerHeight - backButton.offsetHeight));

                backButton.style.left = currentX + 'px';
                backButton.style.top = currentY + 'px';
            }

            function dragEnd() {
                isDragging = false;
            }

            // Add touch support
            backButton.addEventListener('touchstart', function(e) {
                const touch = e.touches[0];
                initialX = touch.clientX - backButton.offsetLeft;
                initialY = touch.clientY - backButton.offsetTop;
                isDragging = true;
            });

            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;

                e.preventDefault();
                const touch = e.touches[0];
                currentX = touch.clientX - initialX;
                currentY = touch.clientY - initialY;

                currentX = Math.max(0, Math.min(currentX, window.innerWidth - backButton.offsetWidth));
                currentY = Math.max(0, Math.min(currentY, window.innerHeight - backButton.offsetHeight));

                backButton.style.left = currentX + 'px';
                backButton.style.top = currentY + 'px';
            });

            document.addEventListener('touchend', function() {
                isDragging = false;
            });
        });
    </script>
</body>
</html>